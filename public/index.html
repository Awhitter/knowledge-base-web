<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Knowledge Base</title>
    <style>
        /* ... (CSS styles remain the same) ... */
        
        /* Tracker Page Styles */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status-badge.queued {
            background: #ffc107;
            color: #000;
        }
        
        .status-badge.processing {
            background: #007bff;
            color: white;
        }
        
        .status-badge.complete {
            background: #28a745;
            color: white;
        }
        
        .status-badge.failed,
        .status-badge.error {
            background: #dc3545;
            color: white;
        }
        
        .lane-event {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-left: 4px solid #ddd;
            background: #f9f9f9;
            border-radius: 4px;
        }
        
        .lane-event.lane_start {
            border-left-color: #007bff;
            background: #e7f3ff;
        }
        
        .lane-event.lane_finish {
            border-left-color: #28a745;
            background: #e7f9e7;
        }
        
        .lane-event.lane_error {
            border-left-color: #dc3545;
            background: #ffe7e7;
        }
        
        .lane-event.publish {
            border-left-color: #6f42c1;
            background: #f3e7ff;
        }
        
        .lane-event.done {
            border-left-color: #28a745;
            background: #d4edda;
            font-weight: bold;
        }
        
        .lane-event-time {
            font-size: 0.75rem;
            color: #666;
            margin-bottom: 0.25rem;
        }
        
        .lane-event-message {
            font-weight: bold;
            margin-bottom: 0.25rem;
        }
        
        .lane-event-details {
            font-size: 0.875rem;
            color: #555;
        }
        /* SSE Modal Styles */
        .sse-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.2s;
        }
        
        .sse-modal-content {
            background: white;
            border-radius: 12px;
            width: 700px;
            max-width: 90vw;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .sse-header {
            padding: 20px 24px;
            border-bottom: 2px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px 12px 0 0;
        }
        
        .sse-header h2 {
            margin: 0;
            font-size: 20px;
        }
        
        .close-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        
        .close-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .sse-status {
            padding: 16px 24px;
            background: #f7fafc;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .status-dot.connecting {
            background: #ed8936;
        }
        
        .status-dot.connected {
            background: #48bb78;
        }
        
        .status-dot.error {
            background: #f56565;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .sse-stats {
            padding: 16px 24px;
            display: flex;
            gap: 24px;
            background: #fff;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .sse-stats .stat {
            font-size: 13px;
            color: #4a5568;
        }
        
        .sse-stats .stat strong {
            color: #2d3748;
        }
        
        .sse-events {
            padding: 16px 24px;
            overflow-y: auto;
            flex: 1;
            min-height: 300px;
            max-height: 500px;
        }
        
        .sse-event {
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            display: flex;
            gap: 12px;
            align-items: center;
            font-size: 14px;
            animation: slideIn 0.3s;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .sse-event.connected { background: #f0fff4; border-left: 3px solid #48bb78; }
        .sse-event.lane_start { background: #ebf8ff; border-left: 3px solid #4299e1; }
        .sse-event.lane_finish { background: #f0fff4; border-left: 3px solid #48bb78; }
        .sse-event.lane_error { background: #fff5f5; border-left: 3px solid #f56565; }
        .sse-event.publish { background: #faf5ff; border-left: 3px solid #9f7aea; }
        .sse-event.done { background: #fffff0; border-left: 3px solid #ecc94b; }
        .sse-event.progress { background: #f7fafc; border-left: 3px solid #a0aec0; }
        
        .event-icon {
            font-size: 18px;
        }
        
        .event-time {
            color: #718096;
            font-size: 12px;
            min-width: 80px;
        }
        
        .event-type {
            font-weight: 600;
            color: #2d3748;
            min-width: 100px;
        }
        
        .event-message {
            color: #4a5568;
            flex: 1;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-container {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        /* Article Modal */
        .article-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.2s;
        }
        
        .article-modal-content {
            background: white;
            border-radius: 12px;
            width: 800px;
            max-width: 90vw;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .article-modal-header {
            padding: 20px 24px;
            border-bottom: 2px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .article-modal-header h2 {
            margin: 0;
            font-size: 20px;
        }
        
        .article-modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }
        
        .article-meta {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e2e8f0;
            flex-wrap: wrap;
        }
        
        .article-meta-item {
            font-size: 14px;
            color: #666;
        }
        
        .article-meta-item strong {
            color: #333;
        }
        
        .article-content {
            line-height: 1.6;
            color: #333;
        }
        
        /* Form Validation */
        .form-error {
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: none;
        }
        
        .form-error.show {
            display: block;
        }
        
        input.error, select.error, textarea.error {
            border-color: #dc3545 !important;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-content">
            <a href="#" class="navbar-brand">üìö Knowledge Base</a>
            <ul class="navbar-menu">
                <li><a href="#" data-page="dashboard" class="nav-link active">Dashboard</a></li>
                <li><a href="#" data-page="prompts" class="nav-link">Prompts</a></li>
                <li><a href="#" data-page="workflows" class="nav-link">Workflows</a></li>
                <li><a href="#" data-page="entities" class="nav-link">Entities</a></li>
                <li><a href="#" data-page="tools" class="nav-link">Tools</a></li>
                <li><a href="#" data-page="references" class="nav-link">References</a></li>
                <li><a href="#" data-page="content-hub" class="nav-link">Content Hub</a></li>
                <li><a href="#" data-page="new-request" class="nav-link">New Request</a></li>
                <li><a href="#" data-page="tracker" class="nav-link">Tracker</a></li>
                <li><a href="#" data-page="analytics" class="nav-link">üìä Analytics</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        
        <!-- Dashboard Page -->
        <div id="dashboard" class="page active">
            <h2>üìä Dashboard</h2>
            
            <!-- Stats Grid -->
            <div class="grid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;margin:1.5rem 0;">
                <div class="card" style="padding:1rem;text-align:center;">
                    <div id="totalRequests" style="font-weight:700;font-size:2rem;color:#333;">0</div>
                    <div style="color:#666;font-size:0.9rem;">Total Requests</div>
                </div>
                <div class="card" style="padding:1rem;text-align:center;">
                    <div id="completedRequests" style="font-weight:700;font-size:2rem;color:#22c55e;">0</div>
                    <div style="color:#666;font-size:0.9rem;">Completed</div>
                </div>
                <div class="card" style="padding:1rem;text-align:center;">
                    <div id="processingRequests" style="font-weight:700;font-size:2rem;color:#3b82f6;">0</div>
                    <div style="color:#666;font-size:0.9rem;">Processing</div>
                </div>
                <div class="card" style="padding:1rem;text-align:center;">
                    <div id="failedRequests" style="font-weight:700;font-size:2rem;color:#ef4444;">0</div>
                    <div style="color:#666;font-size:0.9rem;">Failed</div>
                </div>
            </div>
            
            <!-- Recent Requests Table -->
            <div class="card" style="margin-top:2rem;">
                <h3 style="margin-bottom:1rem;">Recent Requests</h3>
                <table style="width:100%;border-collapse:collapse;">
                    <thead>
                        <tr style="background:#f5f5f5;border-bottom:2px solid #ddd;">
                            <th style="padding:.75rem;text-align:left;">Request</th>
                            <th style="padding:.75rem;text-align:left;">Status</th>
                            <th style="padding:.75rem;text-align:left;">Created</th>
                            <th style="padding:.75rem;text-align:left;">Workflow</th>
                            <th style="padding:.75rem;text-align:left;">Last Update</th>
                            <th style="padding:.75rem;text-align:left;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="recentRequests">
                        <tr><td colspan="6" style="padding:2rem;text-align:center;color:#999;">
                            No requests yet. Use the "New Request" page to start a workflow.
                        </td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Prompts Page -->
        <div id="prompts" class="page">
            <h2>üìù Prompts Library</h2>
            <div id="promptsContainer" class="grid-container">
                <!-- Live data will be injected here -->
            </div>
            <p id="promptsEmpty" style="display: none;">No prompts found in the library.</p>
        </div>

        <!-- Workflows Page -->
        <div id="workflows" class="page">
            <h2>‚öôÔ∏è Workflows</h2>
            <div id="workflowsGrid" class="grid-container">
                <!-- Live data will be injected here -->
            </div>
            <p id="workflowsEmpty" style="display: none;">No workflows found.</p>
        </div>

        <!-- Entities Page -->
        <div id="entities" class="page">
            <h2>üèõÔ∏è Entities</h2>
            <div id="entitiesContainer" class="grid-container">
                <!-- Live data will be injected here -->
            </div>
            <p id="entitiesEmpty" style="display: none;">No entities found.</p>
        </div>
        
        <!-- Tools Page - NEW -->
        <div id="tools" class="page">
            <h2>üõ†Ô∏è Tools Library</h2>
            <div id="toolsGrid" class="grid-container">
                <!-- Live data will be injected here -->
            </div>
            <p id="toolsEmpty" style="display: none;">No tools found in the library.</p>
        </div>

        <!-- References Page - NEW -->
        <div id="references" class="page">
            <h2>üîó References Library</h2>
            <div id="referencesGrid" class="grid-container">
                <!-- Live data will be injected here -->
            </div>
            <p id="referencesEmpty" style="display: none;">No references found in the library.</p>
        </div>

        <!-- Content Hub Page -->
        <div id="content-hub" class="page">
            <h2>üìö Content Hub</h2>
            
            <!-- Filtering Controls -->
            <div class="card" style="margin-bottom: 2rem;">
                <h3 style="margin-bottom: 1rem;">üîç Filter & Search</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Search</label>
                        <input type="text" id="contentHubSearch" placeholder="Search articles..." 
                               style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Brand</label>
                        <select id="contentHubBrandFilter" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">All Brands</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Content Type</label>
                        <select id="contentHubTypeFilter" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">All Types</option>
                            <option value="Article">Article</option>
                            <option value="Blog Post">Blog Post</option>
                            <option value="Research Report">Research Report</option>
                            <option value="Social Media">Social Media</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Date Range</label>
                        <select id="contentHubDateFilter" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="all">All Time</option>
                            <option value="7">Last 7 Days</option>
                            <option value="30">Last 30 Days</option>
                            <option value="90">Last 90 Days</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 1rem; display: flex; gap: 0.5rem; align-items: center; justify-content: space-between;">
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <button id="contentHubClearFilters" class="button" style="background: #6c757d;">Clear Filters</button>
                        <span id="contentHubResultCount" style="color: #666; font-size: 0.875rem;"></span>
                    </div>
                    <button id="exportContentHubBtn" class="button" style="background: #3b82f6;">üì• Export to CSV</button>
                </div>
            </div>
            
            <div id="contentHubGrid" class="grid-container">
                <!-- Live data will be injected here -->
            </div>
            <p id="contentHubEmpty" style="display: none;">No content found in the hub.</p>
        </div>

        <!-- New Request Page -->
        <div id="new-request" class="page">
            <h2>‚ú® New Request</h2>
            <div class="card" style="max-width: 800px; margin: 0 auto;">
                <form id="newRequestForm">
                    <div style="margin-bottom: 1.5rem;">
                        <label for="workflow" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Workflow</label>
                        <select id="workflow" name="workflow" required style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">Select a workflow...</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label for="entity" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Entity (Optional)</label>
                        <select id="entity" name="entity" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">Select an entity...</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label for="persona" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Persona (Optional)</label>
                        <select id="persona" name="persona" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">Select a persona...</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label for="priority" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Priority</label>
                        <select id="priority" name="priority" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                            <option value="Low">Low</option>
                            <option value="Urgent">Urgent</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label for="goal" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Goal (Optional)</label>
                        <small style="display: block; margin-bottom: 0.5rem; color: #666;">What do you want to achieve with this request?</small>
                        <textarea id="goal" name="goal" rows="3" 
                                  style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-family: inherit;"
                                  placeholder="e.g., Create engaging content for social media campaign..."></textarea>
                        <div style="text-align: right; font-size: 0.75rem; color: #999; margin-top: 0.25rem;">
                            <span id="goalCharCount">0</span> characters
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label for="rawInput" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Input / Instructions <span style="color: #ef4444;">*</span></label>
                        <small style="display: block; margin-bottom: 0.5rem; color: #666;">Provide detailed instructions or context for your request</small>
                        <textarea id="rawInput" name="rawInput" rows="6" required 
                                  style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-family: inherit;"
                                  placeholder="Enter your request or instructions here..."></textarea>
                        <div style="text-align: right; font-size: 0.75rem; color: #999; margin-top: 0.25rem;">
                            <span id="rawInputCharCount">0</span> characters
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label for="referenceUrls" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Reference URLs (Optional)</label>
                        <small style="display: block; margin-bottom: 0.5rem; color: #666;">Add URLs for reference materials (one per line)</small>
                        <textarea id="referenceUrls" name="referenceUrls" rows="3" 
                                  style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-family: inherit;"
                                  placeholder="https://example.com/article1\nhttps://example.com/article2"></textarea>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label for="notes" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Additional Notes (Optional)</label>
                        <small style="display: block; margin-bottom: 0.5rem; color: #666;">Any other information that might be helpful</small>
                        <textarea id="notes" name="notes" rows="3" 
                                  style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-family: inherit;"
                                  placeholder="Add any additional notes or special requirements..."></textarea>
                        <div style="text-align: right; font-size: 0.75rem; color: #999; margin-top: 0.25rem;">
                            <span id="notesCharCount">0</span> characters
                        </div>
                    </div>
                    
                    <button id="submitButton" type="submit" class="button" style="width: 100%;">
                        Submit Request
                    </button>
                    
                    <div id="successMessage" style="display: none; margin-top: 1rem; padding: 1rem; background: #d1fae5; border: 1px solid #10b981; border-radius: 4px; color: #065f46;">
                        Request submitted successfully!
                    </div>
                    
                    <div id="errorMessage" style="display: none; margin-top: 1rem; padding: 1rem; background: #fee2e2; border: 1px solid #ef4444; border-radius: 4px; color: #991b1b;">
                        Error submitting request. Please try again.
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Request Tracker Page -->
        <div id="tracker" class="page">
            <h2>üìä Request Tracker</h2>
            <p>Monitor the real-time progress of your content creation workflows. Each lane represents a step in the AI pipeline.</p>
            
            <!-- Filtering Controls -->
            <div class="card" style="margin-bottom: 2rem;">
                <h3 style="margin-bottom: 1rem;">üîç Filter & Search</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Search</label>
                        <input type="text" id="trackerSearch" placeholder="Search requests..." 
                               style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Status</label>
                        <select id="trackerStatusFilter" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">All Statuses</option>
                            <option value="Queued">Queued</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Complete">Complete</option>
                            <option value="Error">Error</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Workflow</label>
                        <select id="trackerWorkflowFilter" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">All Workflows</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Date Range</label>
                        <select id="trackerDateFilter" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="all">All Time</option>
                            <option value="7">Last 7 Days</option>
                            <option value="30">Last 30 Days</option>
                            <option value="90">Last 90 Days</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 1rem; display: flex; gap: 0.5rem; align-items: center;">
                    <button id="trackerClearFilters" class="button" style="background: #6c757d;">Clear Filters</button>
                    <span id="trackerResultCount" style="color: #666; font-size: 0.875rem;"></span>
                </div>
            </div>
            
            <!-- Recent Requests Table -->
            <div style="margin-top: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="margin: 0;">Recent Requests</h3>
                    <div style="display: flex; gap: 0.5rem;">
                        <button id="exportSelectedBtn" class="button" style="background: #10b981; display: none;">üì• Export Selected</button>
                        <button id="exportAllBtn" class="button" style="background: #3b82f6;">üì• Export All</button>
                    </div>
                </div>
                <table style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
                    <thead>
                        <tr style="background: #f5f5f5; border-bottom: 2px solid #ddd;">
                            <th style="padding: 0.75rem; text-align: left; width: 40px;">
                                <input type="checkbox" id="selectAllTracker" style="cursor: pointer;">
                            </th>
                            <th style="padding: 0.75rem; text-align: left;">Request</th>
                            <th style="padding: 0.75rem; text-align: left;">Status</th>
                            <th style="padding: 0.75rem; text-align: left;">Created</th>
                            <th style="padding: 0.75rem; text-align: left;">Workflow</th>
                            <th style="padding: 0.75rem; text-align: left;">Last Update</th>
                            <th style="padding: 0.75rem; text-align: left;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="trackerTableBody">
                        <tr><td colspan="6" style="padding: 2rem; text-align: center; color: #999;">No requests submitted yet. Use the "New Request" page to start a workflow.</td></tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Live Progress Monitor (shown when tracking a specific request) -->
            <div id="liveProgressMonitor" style="display: none; margin-top: 3rem; padding: 2rem; background: #f9f9f9; border-radius: 8px; border: 2px solid #007bff;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="margin: 0;">üî¥ Live Progress Monitor</h3>
                    <button onclick="closeLiveMonitor()" style="padding: 0.5rem 1rem; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">Close</button>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <strong>Record ID:</strong> <span id="monitorRecordId">-</span><br>
                    <strong>Connection Status:</strong> <span id="monitorConnectionStatus" style="color: #999;">Disconnected</span>
                </div>
                
                <!-- Lane Progress Timeline -->
                <div id="laneTimeline" style="margin-top: 2rem;">
                    <h4>Lane Execution Timeline</h4>
                    <div id="laneEvents" style="max-height: 400px; overflow-y: auto; background: white; padding: 1rem; border-radius: 4px; border: 1px solid #ddd;">
                        <p style="color: #999; text-align: center;">Waiting for events...</p>
                    </div>
                </div>
                
                <!-- Summary Stats -->
                <div id="progressStats" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-top: 2rem;">
                    <div style="padding: 1rem; background: white; border-radius: 4px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; color: #007bff;" id="statLanesStarted">0</div>
                        <div style="color: #666; font-size: 0.875rem;">Lanes Started</div>
                    </div>
                    <div style="padding: 1rem; background: white; border-radius: 4px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; color: #28a745;" id="statLanesCompleted">0</div>
                        <div style="color: #666; font-size: 0.875rem;">Lanes Completed</div>
                    </div>
                    <div style="padding: 1rem; background: white; border-radius: 4px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; color: #dc3545;" id="statLanesErrors">0</div>
                        <div style="color: #666; font-size: 0.875rem;">Errors</div>
                    </div>
                    <div style="padding: 1rem; background: white; border-radius: 4px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; color: #6c757d;" id="statElapsedTime">0s</div>
                        <div style="color: #666; font-size: 0.875rem;">Elapsed Time</div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Global variable to hold live data
        let liveData = {
            prompts: [],
            workflows: [],
            entities: [],
            tools: [], // NEW
            references: [], // NEW
            contentInitiators: [], // Live requests for tracker
            contentTypes: [],
            formSchema: [],
            // Mock data for initial load until live data is fetched
            mockData: {
                prompts: [{ id: 'm1', name: 'Loading...', description: 'Fetching live data...' }],
                workflows: [{ id: 'm1', name: 'Loading...', description: 'Fetching live data...' }],
                entities: [{ id: 'm1', name: 'Loading...', description: 'Fetching live data...' }],
                tools: [{ id: 'm1', name: 'Loading...', description: 'Fetching live data...' }], // NEW
                references: [{ id: 'm1', name: 'Loading...', description: 'Fetching live data...' }], // NEW
                contentInitiators: [],
                contentTypes: []
            },
            // New: Store IDs of submitted requests for tracking
            submittedRequests: JSON.parse(localStorage.getItem('submittedRequests')) || []
        };
        
        const TRACKER_POLL_INTERVAL = 5000; // Poll every 5 seconds

        // --- Core Functions ---

        async function fetchLiveData() {
            try {
                const response = await fetch('/api/data/live');
                if (!response.ok) throw new Error('Failed to fetch live data from server.');
                const data = await response.json();
                
                liveData.prompts = data.prompts;
                liveData.workflows = data.workflows;
                liveData.entities = data.entities;
                liveData.tools = data.tools; // NEW
                liveData.references = data.references; // NEW
                liveData.contentTypes = data.contentTypes;
                
                // Fetch the form schema (still static for now, but will be replaced by live fetch)
                const schemaResponse = await fetch('/api/data/form-schema');
                if (schemaResponse.ok) {
                    liveData.formSchema = await schemaResponse.json();
                }

                // Initial load of pages that depend on data
                loadDashboard();
                loadPrompts();
                loadWorkflows();
                loadEntities();
                loadTools(); // NEW
                loadReferences(); // NEW
                loadContentHub();
                loadNewRequestForm();
                loadTracker();
                
                // Start the tracking poll
                startTrackingPoll();
                
            } catch (error) {
                console.error('Error fetching live data:', error);
                // Fallback to mock data if live fetch fails
                loadDashboard();
                loadPrompts();
                loadWorkflows();
                loadEntities();
                loadTools(); // NEW
                loadReferences(); // NEW
                loadContentHub();
                loadNewRequestForm();
                loadTracker();
            }
        }
        
        function startTrackingPoll() {
            // Only start polling if there are requests to track
            if (liveData.submittedRequests.length > 0) {
                setInterval(updateTrackerStatus, TRACKER_POLL_INTERVAL);
            }
        }

        async function updateTrackerStatus() {
            const updates = await Promise.all(liveData.submittedRequests.map(async (req) => {
                try {
                    const response = await fetch(`/api/requests/status/${req.recordId}`);
                    if (!response.ok) throw new Error('Failed to fetch status');
                    const data = await response.json();
                    return { ...req, status: data.status, lastChecked: new Date().toLocaleTimeString() };
                } catch (error) {
                    // Assume 'Queued' if there's an error, or 'Error' if it's a persistent issue
                    return { ...req, status: req.status === 'Queued' ? 'Queued' : 'Error', lastChecked: new Date().toLocaleTimeString() };
                }
            }));
            
            // Update the global list and local storage
            liveData.submittedRequests = updates;
            localStorage.setItem('submittedRequests', JSON.stringify(updates));
            
            // If the user is on the tracker page, reload it
            if (document.getElementById('tracker').classList.contains('active')) {
                loadTracker();
            }
        }

        // --- Navigation and Page Loading ---

        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const pageName = link.dataset.page;
                
                // Update active nav link
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                
                // Show active page
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById(pageName).classList.add('active');
                
                // Load page data
                loadPageData(pageName);
            });
        });

        function loadPageData(pageName) {
            switch(pageName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'prompts':
                    loadPrompts();
                    break;
                case 'workflows':
                    loadWorkflows();
                    break;
                case 'entities':
                    loadEntities();
                    break;
                case 'tools': // NEW
                    loadTools();
                    break;
                case 'references': // NEW
                    loadReferences();
                    break;
                case 'content-hub':
                    loadContentHub();
                    break;
                case 'new-request':
                    loadNewRequestForm();
                    break;
                case 'tracker':
                    loadTracker();
                    break;
                case 'analytics':
                    if (window.showAnalytics) {
                        showAnalytics();
                    }
                    break;
            }
        }
        
        // --- Page Logic Functions (Updated to use liveData) ---

        async function loadDashboard() {
            // Show loading state
            const recentTable = document.getElementById('recentRequests');
            if (recentTable) {
                recentTable.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;"><div class="loading-spinner"></div></td></tr>';
            }
            
            try {
                // Fetch submitted requests to calculate stats
                const response = await fetch('/api/requests/submitted');
                if (!response.ok) throw new Error('Failed to fetch requests');
                
                const data = await response.json();
                const items = data.items || [];
                
                const stats = {
                    total: items.length,
                    completed: items.filter(c => c.status === 'completed').length,
                    processing: items.filter(c => c.status === 'processing').length,
                    failed: items.filter(c => c.status === 'failed').length
                };

                document.getElementById('totalRequests').textContent = stats.total;
                document.getElementById('completedRequests').textContent = stats.completed;
                document.getElementById('processingRequests').textContent = stats.processing;
                document.getElementById('failedRequests').textContent = stats.failed;

                const recentTable = document.getElementById('recentRequests');
                if (items.length > 0) {
                    recentTable.innerHTML = items.slice(0, 5).map(item => `
                        <tr>
                            <td>${item.name}</td>
                            <td><span class="status-badge ${item.status}">${item.status.toUpperCase()}</span></td>
                            <td>${item.createdTime ? new Date(item.createdTime).toLocaleString() : 'Unknown'}</td>
                            <td>${item.workflow}</td>
                            <td>-</td>
                            <td>${item.outputRecordId ? `<a href="#" onclick="viewArticle('${item.outputRecordId}'); return false;">View</a>` : '-'}</td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
                // Set default values on error
                document.getElementById('totalRequests').textContent = '0';
                document.getElementById('completedRequests').textContent = '0';
                document.getElementById('processingRequests').textContent = '0';
                document.getElementById('failedRequests').textContent = '0';
            }
        }

        function loadPrompts() {
            const container = document.getElementById('promptsContainer');
            const empty = document.getElementById('promptsEmpty');
            
            const data = liveData.prompts.length > 0 ? liveData.prompts : liveData.mockData.prompts;

            if (data.length > 0) {
                container.innerHTML = data.map(prompt => `
                    <div class="card" style="margin-bottom: 20px;">
                        <h3>${prompt.fields['Prompt Name'] || prompt.id}</h3>
                        <p>${prompt.fields['Description'] || 'No description'}</p>
                        <span class="badge">${prompt.fields['Prompt Category'] || 'General'}</span>
                        <span class="badge">${prompt.fields['Prompt Type'] || 'Template'}</span>
                        <br><br>
                        <button class="collapsible" onclick="toggleCollapsible(this)">View Prompt Text</button>
                        <div class="content">
                            <pre>${prompt.fields['Prompt Text'] || 'No prompt text available.'}</pre>
                        </div>
                        <button class="button button.small" onclick="usePrompt('${prompt.id}', '${prompt.fields['Prompt Text']}')">Use Prompt</button>
                    </div>
                `).join('');
                empty.style.display = 'none';
            } else {
                empty.style.display = 'block';
            }
        }

        function loadWorkflows() {
            const grid = document.getElementById('workflowsGrid');
            const empty = document.getElementById('workflowsEmpty');
            
            const data = liveData.workflows.length > 0 ? liveData.workflows : liveData.mockData.workflows;

            if (data.length > 0) {
                grid.innerHTML = data.map(workflow => `
                    <div class="item-card">
                        <h3>${workflow.fields['Workflow Name'] || workflow.id}</h3>
                        <p>${workflow.fields['Description'] || 'No description'}</p>
                        <span class="badge">${workflow.fields['Workflow Type'] || 'General'}</span>
                        <span class="badge">${workflow.fields['Total Steps'] || 'N/A'} steps</span>
                        <br><br>
                        <button class="button button.small" onclick="runWorkflow('${workflow.id}')">Run Workflow</button>
                    </div>
                `).join('');
                empty.style.display = 'none';
            } else {
                empty.style.display = 'block';
            }
        }

        function loadEntities() {
            const container = document.getElementById('entitiesContainer');
            const empty = document.getElementById('entitiesEmpty');
            
            const data = liveData.entities.length > 0 ? liveData.entities : liveData.mockData.entities;

            if (data.length > 0) {
                container.innerHTML = data.map(entity => `
                    <div class="card" style="margin-bottom: 20px;">
                        <h3>${entity.fields['Entity Name'] || entity.id}</h3>
                        <p>${entity.fields['Description'] || 'No description'}</p>
                        <span class="badge">${entity.fields['Entity Type'] || 'General'}</span>
                        <br><br>
                        <button class="collapsible" onclick="toggleCollapsible(this)">View Knowledge Base XML</button>
                        <div class="content">
                            <pre>${entity.fields['Knowledge Base XML'] || 'No XML available.'}</pre>
                        </div>
                    </div>
                `).join('');
                empty.style.display = 'none';
            } else {
                empty.style.display = 'block';
            }
        }
        
        // NEW: Load Tools
        function loadTools() {
            const grid = document.getElementById('toolsGrid');
            const empty = document.getElementById('toolsEmpty');
            
            const data = liveData.tools.length > 0 ? liveData.tools : liveData.mockData.tools;

            if (data.length > 0) {
                grid.innerHTML = data.map(tool => `
                    <div class="item-card">
                        <h3>üõ†Ô∏è ${tool.fields['Tool Name'] || tool.id}</h3>
                        <p>${tool.fields['Description'] || 'No description'}</p>
                        <span class="badge">${tool.fields['Category'] || 'General'}</span>
                        <span class="badge">${tool.fields['Integration Type'] || 'API'}</span>
                        <br><br>
                        <button class="collapsible" onclick="toggleCollapsible(this)">View Details</button>
                        <div class="content">
                            <pre>${tool.fields['Usage Instructions'] || 'No instructions available.'}</pre>
                        </div>
                    </div>
                `).join('');
                empty.style.display = 'none';
            } else {
                empty.style.display = 'block';
            }
        }

        // NEW: Load References
        function loadReferences() {
            const grid = document.getElementById('referencesGrid');
            const empty = document.getElementById('referencesEmpty');
            
            const data = liveData.references.length > 0 ? liveData.references : liveData.mockData.references;

            if (data.length > 0) {
                grid.innerHTML = data.map(ref => `
                    <div class="item-card">
                        <h3>üîó ${ref.fields['Reference Name'] || ref.id}</h3>
                        <p>${ref.fields['Summary'] || 'No summary'}</p>
                        <span class="badge">${ref.fields['Type'] || 'Document'}</span>
                        <span class="badge">${ref.fields['Source'] || 'Internal'}</span>
                        <br><br>
                        <a href="${ref.fields['URL'] || '#'}" target="_blank" class="button button.small">View Source</a>
                    </div>
                `).join('');
                empty.style.display = 'none';
            } else {
                empty.style.display = 'block';
            }
        }

        let allContentHubItems = []; // Store all items for filtering
        let contentHubFilters = {
            search: '',
            brand: '',
            type: '',
            dateRange: 'all'
        };
        
        async function loadContentHub() {
            const grid = document.getElementById('contentHubGrid');
            const empty = document.getElementById('contentHubEmpty');
            
            // Show loading state
            grid.innerHTML = '<div class="loading-container"><div class="loading-spinner"></div><p>Loading articles...</p></div>';
            empty.style.display = 'none';
            
            try {
                // Fetch published articles from new API endpoint
                const response = await fetch('/api/content-hub/articles');
                if (!response.ok) throw new Error('Failed to fetch articles');
                
                const data = await response.json();
                allContentHubItems = data.items || [];
                
                // Populate brand filter dropdown
                populateContentHubBrandFilter();
                
                // Apply filters and render
                applyContentHubFilters();
                
            } catch (error) {
                console.error('Error loading Content Hub:', error);
                if (empty) {
                    empty.textContent = 'Error loading articles. Please try again.';
                    empty.style.display = 'block';
                }
            }
        }
        
        function populateContentHubBrandFilter() {
            const brandFilter = document.getElementById('contentHubBrandFilter');
            if (!brandFilter) return;
            
            // Get unique brands
            const brands = [...new Set(allContentHubItems.map(item => item.brand).filter(Boolean))];
            
            brandFilter.innerHTML = '<option value="">All Brands</option>' + 
                brands.map(b => `<option value="${b}">${b}</option>`).join('');
        }
        
        function applyContentHubFilters() {
            const contentGrid = document.getElementById('contentGrid');
            if (!contentGrid) return;
            
            // Apply semantic search if available
            let filteredItems = allContentItems;
            if (contentFilters.search && window.semanticSearch) {
                filteredItems = window.semanticSearch.search(
                    contentFilters.search,
                    allContentItems,
                    ['title', 'subtitle', 'cardText', 'brand', 'contentType']
                );
            }
            
            // Apply other filters
            filteredItems = filteredItems.filter(item => {
                
                // Brand filter
                if (contentHubFilters.brand && item.brand !== contentHubFilters.brand) {
                    return false;
                }
                
                // Type filter
                if (contentHubFilters.type && item.articleType !== contentHubFilters.type) {
                    return false;
                }
                
                // Date range filter
                if (contentHubFilters.dateRange !== 'all' && item.publishDate) {
                    const itemDate = new Date(item.publishDate);
                    const now = new Date();
                    const daysAgo = parseInt(contentHubFilters.dateRange);
                    const cutoffDate = new Date(now.getTime() - (daysAgo * 24 * 60 * 60 * 1000));
                    if (itemDate < cutoffDate) return false;
                }
                
                return true;
            });
            
            // Update result count
            const resultCount = document.getElementById('contentHubResultCount');
            if (resultCount) {
                resultCount.textContent = `Showing ${filteredItems.length} of ${allContentHubItems.length} articles`;
            }
            
            // Render filtered items
            if (filteredItems.length === 0) {
                empty.textContent = 'No articles match your filters.';
                empty.style.display = 'block';
                grid.innerHTML = '';
                return;
            }
            
            grid.innerHTML = filteredItems.map(article => `
                <div style="border:1px solid #ddd; border-radius:0.5rem; overflow:hidden; cursor:pointer;" onclick="viewArticle('${article.id}')">
                    ${article.cardImage ? 
                        `<img src="${article.cardImage}" alt="${article.title}" style="width:100%; height:200px; object-fit:cover;">` :
                        '<div style="width:100%; height:200px; background:#f3f4f6; display:flex; align-items:center; justify-content:center; color:#9ca3af;">No Image</div>'
                    }
                    <div style="padding:1rem;">
                        <div style="font-size:0.75rem; color:#6b7280; margin-bottom:0.5rem;">
                            ${article.articleType || 'Article'} ‚Ä¢ ${article.brand || 'Unknown'}
                        </div>
                        <h3 style="margin:0 0 0.5rem 0; font-size:1.125rem;">${article.title}</h3>
                        <p style="margin:0; color:#6b7280; font-size:0.875rem; line-height:1.5;">
                            ${article.cardText || article.subtitle || ''}
                        </p>
                        <div style="margin-top:1rem; display:flex; justify-content:space-between; align-items:center; font-size:0.75rem; color:#9ca3af;">
                            <span>${article.readTime || 'Quick read'}</span>
                            <span style="padding:0.25rem 0.5rem; border-radius:0.25rem; background:#f3f4f6;">
                                ${article.status || 'Published'}
                            </span>
                        </div>
                    </div>
                </div>
            `).join('');
            empty.style.display = 'none';
        }
        
        // CSV export for Content Hub
        function exportContentHubToCSV() {
            const itemsToExport = allContentHubItems;
            
            if (itemsToExport.length === 0) {
                alert('No articles to export');
                return;
            }
            
            // CSV headers
            const headers = ['Title', 'Brand', 'Type', 'Status', 'Publish Date', 'Read Time', 'Card Text', 'Subtitle'];
            
            // CSV rows
            const rows = itemsToExport.map(item => [
                item.title || 'Untitled',
                item.brand || 'Unknown',
                item.articleType || 'Article',
                item.status || 'Published',
                item.publishDate ? new Date(item.publishDate).toLocaleDateString() : 'Unknown',
                item.readTime || 'N/A',
                item.cardText || '',
                item.subtitle || ''
            ]);
            
            // Create CSV content
            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
            ].join('\n');
            
            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `content_hub_export_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Setup content hub filter event listeners
        function setupContentHubFilters() {
            const searchInput = document.getElementById('contentHubSearch');
            const brandFilter = document.getElementById('contentHubBrandFilter');
            const typeFilter = document.getElementById('contentHubTypeFilter');
            const dateFilter = document.getElementById('contentHubDateFilter');
            const clearButton = document.getElementById('contentHubClearFilters');
            
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    contentHubFilters.search = e.target.value;
                    applyContentHubFilters();
                });
            }
            
            if (brandFilter) {
                brandFilter.addEventListener('change', (e) => {
                    contentHubFilters.brand = e.target.value;
                    applyContentHubFilters();
                });
            }
            
            if (typeFilter) {
                typeFilter.addEventListener('change', (e) => {
                    contentHubFilters.type = e.target.value;
                    applyContentHubFilters();
                });
            }
            
            if (dateFilter) {
                dateFilter.addEventListener('change', (e) => {
                    contentHubFilters.dateRange = e.target.value;
                    applyContentHubFilters();
                });
            }
            
            if (clearButton) {
                clearButton.addEventListener('click', () => {
                    contentHubFilters = { search: '', brand: '', type: '', dateRange: 'all' };
                    if (searchInput) searchInput.value = '';
                    if (brandFilter) brandFilter.value = '';
                    if (typeFilter) typeFilter.value = '';
                    if (dateFilter) dateFilter.value = 'all';
                    applyContentHubFilters();
                });
            }
            
            // Setup export button
            const exportBtn = document.getElementById('exportContentHubBtn');
            if (exportBtn) {
                exportBtn.addEventListener('click', exportContentHubToCSV);
            }
        }

        async function loadNewRequestForm() {
            // Populate dropdowns from API
            await populateDropdowns();
            // Setup form submission handler
            setupFormSubmission();
            // Setup character counters
            
            // Enhance form with advanced fields (Phase 4)
            const form = document.getElementById('new-request-form');
            if (form && window.enhanceFormWithAdvancedFields) {
                await enhanceFormWithAdvancedFields(form);
            }
            setupCharacterCounters();
        }
        
        function setupCharacterCounters() {
            const fields = [
                { id: 'goal', counterId: 'goalCharCount' },
                { id: 'rawInput', counterId: 'rawInputCharCount' },
                { id: 'notes', counterId: 'notesCharCount' }
            ];
            
            fields.forEach(({ id, counterId }) => {
                const field = document.getElementById(id);
                const counter = document.getElementById(counterId);
                
                if (field && counter) {
                    field.addEventListener('input', () => {
                        counter.textContent = field.value.length;
                    });
                }
            });
        }
        
        async function populateDropdowns() {
            try {
                // Fetch workflows
                const workflows = await fetch('/api/lookups/workflows').then(r => r.json());
                const workflowSelect = document.getElementById('workflow');
                workflowSelect.innerHTML = '<option value="">Select a workflow...</option>' + 
                    workflows.map(w => `<option value="${w.id}">${w.name}</option>`).join('');
                
                // Fetch entities
                const entities = await fetch('/api/lookups/entities').then(r => r.json());
                const entitySelect = document.getElementById('entity');
                entitySelect.innerHTML = '<option value="">Select an entity...</option>' + 
                    entities.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
                
                // Fetch personas
                const personas = await fetch('/api/lookups/personas').then(r => r.json());
                const personaSelect = document.getElementById('persona');
                personaSelect.innerHTML = '<option value="">Select a persona...</option>' + 
                    personas.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            } catch (error) {
                console.error('Failed to populate dropdowns:', error);
                // Show error message to user
                alert('Failed to load form options. Please refresh the page.');
            }
        }
        
        function setupFormSubmission() {

            // Form submission
            document.getElementById('newRequestForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                
                // Clear previous errors
                document.querySelectorAll('.form-error').forEach(el => el.classList.remove('show'));
                document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));
                
                // Validate form
                let isValid = true;
                const workflow = form.querySelector('#workflow');
                const entity = form.querySelector('#entity');
                const persona = form.querySelector('#persona');
                const rawInput = form.querySelector('#rawInput');
                
                if (!workflow.value) {
                    workflow.classList.add('error');
                    isValid = false;
                }
                
                if (!entity.value) {
                    entity.classList.add('error');
                    isValid = false;
                }
                
                if (!persona.value) {
                    persona.classList.add('error');
                    isValid = false;
                }
                
                if (!rawInput.value.trim()) {
                    rawInput.classList.add('error');
                    isValid = false;
                }
                
                if (!isValid) {
                    document.getElementById('errorMessage').textContent = 'Please fill in all required fields.';
                    document.getElementById('errorMessage').style.display = 'block';
                    return;
                }
                
                const formData = {};
                
                // Simple form data collection (needs to be updated for the full dynamic schema)
                formData['Raw User Input'] = rawInput.value;
                formData['Premade AI Workflow'] = [form.querySelector('#workflow').value]; // Airtable link field format
                formData['Persona'] = [form.querySelector('#persona').value]; // Airtable link field format
                formData['What Entity Are We Creating Content On Behalf of?'] = [form.querySelector('#entity').value]; // Airtable link field format
                formData['Priority'] = form.querySelector('#priority').value;

                document.getElementById('submitButton').disabled = true;
                document.getElementById('submitButton').textContent = 'Submitting...';
                
                try {
                    const response = await fetch('/api/requests/new', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });

                    const result = await response.json();

                    if (response.ok) {
                        document.getElementById('successMessage').textContent = `Request submitted successfully! Record ID: ${result.recordId}. Tracking started.`;
                        document.getElementById('successMessage').style.display = 'block';
                        document.getElementById('errorMessage').style.display = 'none';
                        form.reset();
                        
                        // Add the new request to the tracker list
                        liveData.submittedRequests.unshift({
                            recordId: result.recordId,
                            input: rawInput.substring(0, 50) + '...',
                            workflowId: formData['Premade AI Workflow'][0],
                            status: 'Queued',
                            created: new Date().toLocaleDateString()
                        });
                        localStorage.setItem('submittedRequests', JSON.stringify(liveData.submittedRequests));
                        
                        // Start polling if not already started
                        if (liveData.submittedRequests.length === 1) {
                            startTrackingPoll();
                        }
                        
                        // Immediately update the tracker page
                        loadTracker();
                        
                    } else {
                        throw new Error(result.error || 'Unknown error occurred.');
                    }
                } catch (error) {
                    console.error('Submission Error:', error);
                    document.getElementById('errorMessage').textContent = `Submission failed: ${error.message}`;
                    document.getElementById('errorMessage').style.display = 'block';
                    document.getElementById('successMessage').style.display = 'none';
                } finally {
                    document.getElementById('submitButton').disabled = false;
                    document.getElementById('submitButton').textContent = 'Submit Request';
                    setTimeout(() => {
                        document.getElementById('successMessage').style.display = 'none';
                        document.getElementById('errorMessage').style.display = 'none';
                    }, 8000);
                }
            });
        }

        let trackerRefreshInterval = null;
        let allTrackerItems = []; // Store all items for filtering
        let trackerFilters = {
            search: '',
            status: '',
            workflow: '',
            dateRange: 'all'
        };
        
        async function loadTracker() {
            const tableBody = document.getElementById('trackerTableBody');
            
            // Show loading state (only on first load)
            if (!tableBody.innerHTML || tableBody.innerHTML.includes('No requests')) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;"><div class="loading-spinner"></div><p>Loading requests...</p></td></tr>';
            }
            
            try {
                // Fetch submitted requests from new API endpoint
                const response = await fetch('/api/requests/submitted');
                if (!response.ok) throw new Error('Failed to fetch requests');
                
                const data = await response.json();
                allTrackerItems = data.items || [];
                
                // Populate workflow filter dropdown
                populateTrackerWorkflowFilter();
                
                // Apply filters and render
                applyTrackerFilters();
                
            } catch (error) {
                console.error('Error loading tracker:', error);
                tableBody.innerHTML = '<tr><td colspan="6">Error loading requests. Please try again.</td></tr>';
            }
            
            // Setup auto-refresh (30 seconds)
            if (!trackerRefreshInterval) {
                trackerRefreshInterval = setInterval(() => {
                    if (document.getElementById('trackerTableBody')) {
                        loadTracker();
                    } else {
                        // Clear interval if tracker is no longer visible
                        clearInterval(trackerRefreshInterval);
                        trackerRefreshInterval = null;
                    }
                }, 30000); // 30 seconds
            }
        }
        
        function populateTrackerWorkflowFilter() {
            const workflowFilter = document.getElementById('trackerWorkflowFilter');
            if (!workflowFilter) return;
            
            // Get unique workflows
            const workflows = [...new Set(allTrackerItems.map(item => item.workflow).filter(Boolean))];
            
            workflowFilter.innerHTML = '<option value="">All Workflows</option>' + 
                workflows.map(w => `<option value="${w}">${w}</option>`).join('');
        }
        
        function applyTrackerFilters() {
            const tableBody = document.getElementById('trackerTableBody');
            if (!tableBody) return;
            
            // Apply semantic search if available
            let filteredItems = allTrackerItems;
            if (trackerFilters.search && window.semanticSearch) {
                filteredItems = window.semanticSearch.search(
                    trackerFilters.search,
                    allTrackerItems,
                    ['name', 'workflow', 'status', 'entity', 'persona']
                );
            }
            
            // Apply other filters
            filteredItems = filteredItems.filter(item => {
                
                // Status filter
                if (trackerFilters.status && item.status !== trackerFilters.status) {
                    return false;
                }
                
                // Workflow filter
                if (trackerFilters.workflow && item.workflow !== trackerFilters.workflow) {
                    return false;
                }
                
                // Date range filter
                if (trackerFilters.dateRange !== 'all' && item.createdTime) {
                    const itemDate = new Date(item.createdTime);
                    const now = new Date();
                    const daysAgo = parseInt(trackerFilters.dateRange);
                    const cutoffDate = new Date(now.getTime() - (daysAgo * 24 * 60 * 60 * 1000));
                    if (itemDate < cutoffDate) return false;
                }
                
                return true;
            });
            
            // Update result count
            const resultCount = document.getElementById('trackerResultCount');
            if (resultCount) {
                resultCount.textContent = `Showing ${filteredItems.length} of ${allTrackerItems.length} requests`;
            }
            
            // Render filtered items
            if (filteredItems.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" style="padding: 2rem; text-align: center; color: #999;">No requests match your filters.</td></tr>';
                return;
            }
            
            tableBody.innerHTML = filteredItems.map(item => {
                const statusColors = {
                    completed: '#10b981',
                    processing: '#3b82f6',
                    queued: '#6b7280',
                    failed: '#ef4444',
                    'Complete': '#10b981',
                    'In Progress': '#3b82f6',
                    'Queued': '#6b7280',
                    'Error': '#ef4444'
                };
                const statusColor = statusColors[item.status] || '#6b7280';
                const createdDate = item.createdTime ? new Date(item.createdTime).toLocaleString() : 'Unknown';
                const lastUpdate = item.lastModifiedTime ? new Date(item.lastModifiedTime).toLocaleString() : createdDate;
                
                return `
                    <tr style="border-bottom:1px solid #eee;" data-item-id="${item.id}">
                        <td style="padding:0.75rem;">
                            <input type="checkbox" class="tracker-item-checkbox" data-item-id="${item.id}" style="cursor: pointer;">
                        </td>
                        <td style="padding:0.75rem;">${item.name || 'Untitled'}</td>
                        <td style="padding:0.75rem;">
                            <span style="display:inline-block; padding:0.25rem 0.75rem; border-radius:1rem; background:${statusColor}; color:white; font-size:0.875rem;">
                                ${item.status}
                            </span>
                        </td>
                        <td style="padding:0.75rem;">${createdDate}</td>
                        <td style="padding:0.75rem;">${item.workflow || 'N/A'}</td>
                        <td style="padding:0.75rem;">${lastUpdate}</td>
                        <td style="padding:0.75rem;">
                            ${item.outputRecordId ? 
                              `<a href="#" onclick="viewArticle('${item.outputRecordId}'); return false;" style="color:#3b82f6;">View Output</a>` :
                              '<span style="color:#999;">In Progress</span>'
                            }
                            <br>
                            <a href="#" onclick="showWorkflowDiagramById('${item.id}'); return false;" style="color:#6c757d; font-size: 0.875rem;">üìä View Progress</a>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Setup checkbox listeners
            setupTrackerCheckboxes();
        }
        
        // Helper function to show workflow diagram by item ID
        function showWorkflowDiagramById(itemId) {
            const item = allTrackerItems.find(i => i.id === itemId);
            if (item && window.showWorkflowDiagram) {
                window.showWorkflowDiagram(item);
            } else {
                console.error('Item not found or workflow diagram not loaded:', itemId);
            }
        }
        
        // Setup checkbox listeners for bulk operations
        function setupTrackerCheckboxes() {
            const selectAll = document.getElementById('selectAllTracker');
            const checkboxes = document.querySelectorAll('.tracker-item-checkbox');
            const exportSelectedBtn = document.getElementById('exportSelectedBtn');
            
            if (selectAll) {
                selectAll.addEventListener('change', (e) => {
                    checkboxes.forEach(cb => cb.checked = e.target.checked);
                    updateExportButtonVisibility();
                });
            }
            
            checkboxes.forEach(cb => {
                cb.addEventListener('change', () => {
                    updateExportButtonVisibility();
                });
            });
            
            updateExportButtonVisibility();
        }
        
        function updateExportButtonVisibility() {
            const checkboxes = document.querySelectorAll('.tracker-item-checkbox:checked');
            const exportSelectedBtn = document.getElementById('exportSelectedBtn');
            
            if (exportSelectedBtn) {
                exportSelectedBtn.style.display = checkboxes.length > 0 ? 'inline-block' : 'none';
                if (checkboxes.length > 0) {
                    exportSelectedBtn.textContent = `üì• Export Selected (${checkboxes.length})`;
                }
            }
        }
        
        // CSV export functions
        function exportTrackerToCSV(selectedOnly = false) {
            let itemsToExport = allTrackerItems;
            
            if (selectedOnly) {
                const selectedIds = Array.from(document.querySelectorAll('.tracker-item-checkbox:checked'))
                    .map(cb => cb.getAttribute('data-item-id'));
                itemsToExport = allTrackerItems.filter(item => selectedIds.includes(item.id));
            }
            
            if (itemsToExport.length === 0) {
                alert('No items to export');
                return;
            }
            
            // CSV headers
            const headers = ['Request Name', 'Status', 'Workflow', 'Created Date', 'Last Modified', 'Output Record ID'];
            
            // CSV rows
            const rows = itemsToExport.map(item => [
                item.name || 'Untitled',
                item.status || 'Unknown',
                item.workflow || 'N/A',
                item.createdTime ? new Date(item.createdTime).toLocaleString() : 'Unknown',
                item.lastModifiedTime ? new Date(item.lastModifiedTime).toLocaleString() : 'Unknown',
                item.outputRecordId || 'N/A'
            ]);
            
            // Create CSV content
            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');
            
            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `tracker_export_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Setup tracker filter event listeners
        function setupTrackerFilters() {
            const searchInput = document.getElementById('trackerSearch');
            const statusFilter = document.getElementById('trackerStatusFilter');
            const workflowFilter = document.getElementById('trackerWorkflowFilter');
            const dateFilter = document.getElementById('trackerDateFilter');
            const clearButton = document.getElementById('trackerClearFilters');
            
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    trackerFilters.search = e.target.value;
                    applyTrackerFilters();
                });
            }
            
            if (statusFilter) {
                statusFilter.addEventListener('change', (e) => {
                    trackerFilters.status = e.target.value;
                    applyTrackerFilters();
                });
            }
            
            if (workflowFilter) {
                workflowFilter.addEventListener('change', (e) => {
                    trackerFilters.workflow = e.target.value;
                    applyTrackerFilters();
                });
            }
            
            if (dateFilter) {
                dateFilter.addEventListener('change', (e) => {
                    trackerFilters.dateRange = e.target.value;
                    applyTrackerFilters();
                });
            }
            
            if (clearButton) {
                clearButton.addEventListener('click', () => {
                    trackerFilters = { search: '', status: '', workflow: '', dateRange: 'all' };
                    if (searchInput) searchInput.value = '';
                    if (statusFilter) statusFilter.value = '';
                    if (workflowFilter) workflowFilter.value = '';
                    if (dateFilter) dateFilter.value = 'all';
                    applyTrackerFilters();
                });
            }
            
            // Setup export buttons
            const exportSelectedBtn = document.getElementById('exportSelectedBtn');
            const exportAllBtn = document.getElementById('exportAllBtn');
            
            if (exportSelectedBtn) {
                exportSelectedBtn.addEventListener('click', () => exportTrackerToCSV(true));
            }
            
            if (exportAllBtn) {
                exportAllBtn.addEventListener('click', () => exportTrackerToCSV(false));
            }
        }

        // View request with live SSE updates
        function viewRequest(requestId) {
            // Create SSE modal
            const modal = document.createElement('div');
            modal.id = 'sseModal';
            modal.className = 'sse-modal';
            modal.innerHTML = `
                <div class="sse-modal-content">
                    <div class="sse-header">
                        <h2>üî¥ Live Progress Monitor</h2>
                        <button onclick="closeSSEModal()" class="close-btn">‚úï</button>
                    </div>
                    <div class="sse-status">
                        <span id="sseStatusDot" class="status-dot connecting"></span>
                        <span id="sseStatusText">Connecting to live stream...</span>
                    </div>
                    <div class="sse-stats">
                        <div class="stat"><strong>Request ID:</strong> ${requestId.substring(0, 12)}...</div>
                        <div class="stat"><strong>Events:</strong> <span id="eventCount">0</span></div>
                        <div class="stat"><strong>Elapsed:</strong> <span id="elapsedTime">0s</span></div>
                    </div>
                    <div id="sseEvents" class="sse-events"></div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Start elapsed time counter
            const startTime = Date.now();
            const elapsedInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                document.getElementById('elapsedTime').textContent = `${elapsed}s`;
            }, 1000);
            
            // Try SSE connection
            let eventSource;
            let eventCount = 0;
            
            try {
                eventSource = new EventSource(`/api/events/${requestId}`);
                
                eventSource.onopen = () => {
                    document.getElementById('sseStatusDot').className = 'status-dot connected';
                    document.getElementById('sseStatusText').textContent = '‚úì Connected - Receiving live updates';
                };
                
                eventSource.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    addSSEEvent(data);
                    eventCount++;
                    document.getElementById('eventCount').textContent = eventCount;
                };
                
                eventSource.onerror = () => {
                    console.log('SSE connection failed, falling back to polling');
                    document.getElementById('sseStatusDot').className = 'status-dot error';
                    document.getElementById('sseStatusText').textContent = '‚ö† Connection lost - Using polling fallback';
                    eventSource.close();
                    startPolling(requestId);
                };
                
                // Store for cleanup
                window.currentSSE = { eventSource, elapsedInterval };
                
            } catch (error) {
                console.error('Failed to create SSE connection:', error);
                document.getElementById('sseStatusDot').className = 'status-dot error';
                document.getElementById('sseStatusText').textContent = '‚ö† SSE not available - Using polling';
                startPolling(requestId);
            }
        }
        
        function addSSEEvent(event) {
            const eventsDiv = document.getElementById('sseEvents');
            if (!eventsDiv) return;
            
            const eventEl = document.createElement('div');
            eventEl.className = `sse-event ${event.type || 'info'}`;
            
            const time = new Date(event.timestamp || Date.now()).toLocaleTimeString();
            const icon = getEventIcon(event.type);
            
            eventEl.innerHTML = `
                <span class="event-icon">${icon}</span>
                <span class="event-time">${time}</span>
                <span class="event-type">${event.type || 'update'}</span>
                <span class="event-message">${event.message || event.lane || ''}</span>
            `;
            
            eventsDiv.appendChild(eventEl);
            eventsDiv.scrollTop = eventsDiv.scrollHeight;
        }
        
        function getEventIcon(type) {
            const icons = {
                'connected': 'üîó',
                'lane_start': '‚ñ∂Ô∏è',
                'lane_finish': '‚úÖ',
                'lane_error': '‚ùå',
                'publish': 'üì§',
                'done': 'üéâ',
                'progress': '‚è≥'
            };
            return icons[type] || 'üìç';
        }
        
        function startPolling(requestId) {
            const pollInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/requests/status/${requestId}`);
                    if (!response.ok) throw new Error('Polling failed');
                    
                    const status = await response.json();
                    
                    addSSEEvent({
                        type: 'progress',
                        timestamp: new Date().toISOString(),
                        message: `Status: ${status.status}`
                    });
                    
                    if (status.status === 'complete' || status.status === 'failed') {
                        clearInterval(pollInterval);
                        addSSEEvent({
                            type: 'done',
                            timestamp: new Date().toISOString(),
                            message: `Request ${status.status}`
                        });
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                }
            }, 5000); // Poll every 5 seconds
            
            // Store for cleanup
            if (window.currentSSE) {
                window.currentSSE.pollInterval = pollInterval;
            } else {
                window.currentSSE = { pollInterval };
            }
        }
        
        function closeSSEModal() {
            // Cleanup
            if (window.currentSSE) {
                if (window.currentSSE.eventSource) {
                    window.currentSSE.eventSource.close();
                }
                if (window.currentSSE.elapsedInterval) {
                    clearInterval(window.currentSSE.elapsedInterval);
                }
                if (window.currentSSE.pollInterval) {
                    clearInterval(window.currentSSE.pollInterval);
                }
                window.currentSSE = null;
            }
            
            const modal = document.getElementById('sseModal');
            if (modal) {
                modal.remove();
            }
        }

        async function viewArticle(articleId) {
            try {
                const response = await fetch(`/api/content-hub/article/${articleId}`);
                if (!response.ok) throw new Error('Article not found');
                
                const article = await response.json();
                
                // Create modal
                const modal = document.createElement('div');
                modal.className = 'article-modal';
                modal.innerHTML = `
                    <div class="article-modal-content">
                        <div class="article-modal-header">
                            <h2>${article.title || 'Article'}</h2>
                            <button class="close-btn" onclick="this.closest('.article-modal').remove()">&times;</button>
                        </div>
                        <div class="article-modal-body">
                            <div class="article-meta">
                                ${article.status ? `<div class="article-meta-item"><strong>Status:</strong> ${article.status}</div>` : ''}
                                ${article.brand ? `<div class="article-meta-item"><strong>Brand:</strong> ${article.brand}</div>` : ''}
                                ${article.articleType ? `<div class="article-meta-item"><strong>Type:</strong> ${article.articleType}</div>` : ''}
                                ${article.readTime ? `<div class="article-meta-item"><strong>Read Time:</strong> ${article.readTime}</div>` : ''}
                                ${article.publishDate ? `<div class="article-meta-item"><strong>Published:</strong> ${article.publishDate}</div>` : ''}
                            </div>
                            ${article.subtitle ? `<p style="font-size: 1.1em; color: #666; margin-bottom: 20px;">${article.subtitle}</p>` : ''}
                            ${article.cardText ? `<div class="article-content"><p>${article.cardText}</p></div>` : ''}
                            ${article.slug ? `<p style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e2e8f0; color: #666;"><strong>Slug:</strong> ${article.slug}</p>` : ''}
                        </div>
                    </div>
                `;
                
                // Close on background click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });
                
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error viewing article:', error);
                alert('Failed to load article details.');
            }
        }

        function toggleCollapsible(element) {
            element.classList.toggle('active');
            element.nextElementSibling.classList.toggle('active');
        }

        function usePrompt(promptId, promptText) {
            document.getElementById('rawInput').value = `${promptText}`;
            
            // Navigate to new-request page
            document.querySelector('[data-page="new-request"]').click();
        }

        function runWorkflow(workflowId) {
            const workflow = liveData.workflows.find(w => w.id === workflowId);
            document.getElementById('workflow').value = workflowId;
            
            // Navigate to new-request page
            document.querySelector('[data-page="new-request"]').click();
        }

        // viewRequest function is now in tracker-sse.js

        // Load data on page load
        window.addEventListener('load', () => {
            fetchLiveData();
            // Setup filters
            setupTrackerFilters();
            setupContentHubFilters();
            // Load the initial page
            document.querySelector('[data-page="dashboard"]').click();
        });
    </script>
    <!-- Performance Optimization Scripts -->
    <script src="cache-manager.js"></script>
    <script src="lazy-loader.js"></script>
    <script src="pagination.js"></script>
    <script src="error-recovery.js"></script>
    <script src="security.js"></script>
    <script src="monitoring.js"></script>
    
    <!-- Phase 4 Advanced Features -->
    <script src="dynamic-form.js"></script>
    <script src="analytics.js"></script>
    <script src="workflow-diagram.js"></script>
    <script src="semantic-search.js"></script>
    
    <!-- Phase 5 Final Polish -->
    <script src="dark-mode.js"></script>
    <script src="animations.js"></script>
    
    <script src="content-hub.js"></script>
    <script src="tracker-sse.js"></script>
</body>
</html>
